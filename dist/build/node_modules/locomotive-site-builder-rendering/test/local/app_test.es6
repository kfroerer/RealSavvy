import { expect } from 'chai';
import chai from 'chai';
import chaiHttp from 'chai-http';
import nock from 'nock';
import { buildDefaultLocalApp } from '../support/app';

chai.use(chaiHttp);

describe('local/app', function() {

  const app = buildDefaultLocalApp();

  describe('GET /', function() {

    it('redirects to the /themes url', function() {
      chai.request(app).get('/').redirects(0).end(function(err, res) {
        expect(res).to.have.status(301);
        expect(res).to.have.header('location', '/themes');
        done();
      });
    });

  });

  describe('GET /themes', function() {

    it('displays all the themes', function() {
      return chai.request(app).get('/themes').then(function(res) {
        expect(res).to.have.status(200);
        expect(res.text).to.include('<h1>Your themes</h1>');
        expect(res.text).to.include('<a href="/themes/slides">');
      });
    });

  });

  describe('GET /themes/:themeHandle', function() {

    it('renders the default page of a theme', function() {
      return chai.request(app).get('/themes/slides').then(function(res) {
        expect(res).to.have.status(200);
        expect(res.text).to.include('<title>My awesome site</title>');
        expect(res.text).to.include('"/themes/slides/stylesheets/slides.css"');
        expect(res.text).to.include('"/themes/slides/site_builder.js"');
      });
    });

  });

  describe('GET /themes/debug/:filename', function() {

    it('renders the page powered by another sample', function() {
      return chai.request(app).get('/themes/debug/copy_of_slides').then(function(res) {
        expect(res).to.have.status(200);
        expect(res.text).to.include('<title>My awesome site [COPY]</title>');
        expect(res.text).to.include('"/themes/slides/stylesheets/slides.css"');
        expect(res.text).to.include('"/themes/slides/site_builder.js"');
      });
    });

    it('renders the error page and sends the JSON errors in the console', function() {
      return chai.request(app).get('/themes/debug/incorrect_slides').then(function(res) {
        expect(res).to.have.status(200);
        expect(res.text).to.include('<h1>Something went wrong</h1>');
      });
    });

  });

  describe('Custom routes', function() {

    describe('Routes to a templatized page', function() {

      it('renders the page with local data', function() {
        return chai.request(app).get('/themes/slides/hello/john').then(function(res) {
          expect(res).to.have.status(200);
          expect(res).to.have.header('content-type', 'text/html; charset=utf-8');
          expect(res.text).to.include('<title>john</title>');
        });
      });

      it('renders the page with remote data', function() {
        return chai.request(app).get('/themes/slides/users/1').then(function(res) {
          expect(res).to.have.status(200);
          expect(res).to.have.header('content-type', 'text/html; charset=utf-8');
          expect(res.text).to.include('<title>Leanne Graham</title>');
        });
      });

    });

    describe('Routes to a redirection', function() {

      it('redirects to external url', function(done) {
        chai.request(app).get('/themes/slides/simple-redirection').redirects(0)
        .then(Promise.reject)
        .catch(({ response }) => {
          expect(response).to.have.status(302);
          expect(response).to.have.header('location', 'https://www.nocoffee.fr');
          done();
        })
        .catch((err) => { done(err); });
      });

      it('redirects to a locale url', function(done) {
        chai.request(app).get('/themes/slides/local-redirection').redirects(0)
        .then(Promise.reject)
        .catch(({ response }) => {
          expect(response).to.have.status(302);
          expect(response).to.have.header('location', '/foo');
          done();
        })
        .catch((err) => { done(err); });
      });

    });

    describe('Routes rendering a body out of the SiteBuilder platform', function() {

      it('renders the body specified by the custom route', function() {
        return chai.request(app).get('/themes/slides/simple-render').then(function(res) {
          expect(res).to.have.status(200);
          expect(res.text).to.include('success');
        });
      });

    });

  });

});
